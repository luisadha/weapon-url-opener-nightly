#!/data/data/com.termux/files/usr/bin/env bash
# <!DOCTYPE html>  <html lang="id">   <head>       <meta charset="UTF-8" />       <meta name="viewport" content="width=device-width, initial-scale=1.0" />       <title>Weapon-Url-Opener-Nightly | Pilih Aplikasi Termux</title>         <link rel="stylesheet" href="asciinema-player.css" />         <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />        <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.5.0/styles/default.min.css" />         <script src="https://unpkg.com/@highlightjs/cdn-assets@11.5.0/highlight.min.js">         </script><script>hljs.initHighlightingOnLoad();         </script>         <script>function share() {      if (navigator.share) {      navigator.share({          title: document.title,          url: 'https://luisadha.github.io/weapon-url-opener-nightly/'         });      } else {        alert("Fitur berbagi tidak didukung di browser ini.");      }    } </script>          <style>    body {      font-family: monospace;      background: #f5f5f5;      padding: 1em;    }    h2, h3 {      margin-top: 1.5em;    }   code {      display: block;      background: #0b0c0e;      color: #f0f0f0;      padding: 1em;      border-radius: 5px;      overflow-x: auto;    }    .github-fork-ribbon:before {      background-color: #0b0c0e;    }    footer {      font-size: 0.75rem;      margin-top: 3em;    }    .share-line {     display: flex;      align-items: center;     gap: 0.5em;      flex-wrap: wrap;      margin-top: 0.5em;    }    button {      font-family: inherit;      font-size: 0.9em;      padding: 0.4em 0.8em;      border: none;     background: #0b0c0e;      color: white;     border-radius: 4px;      cursor: pointer;    }   button:hover {      background: #333;    }    #player {     max-width: 100%;      margin-top: 1em;    }    iframe, .asciinema-player {      width: 100% !important;      height: auto !important;    }    .note {      font-size: 0.9em;      background: #fff9c4;      padding: 1em;      border-left: 5px solid #fbc02d;      margin-top: 1em;    }  </style>  <style> .share {    font-weight: bold;    position: relative; } .share:before {    content: ".";    font-size: 2.2em;    position: absolute;     bottom: -2.5px;    left: -4px; }  .share:after {     content: ":";    font-size: 2em;    position: absolute;    bottom: -6px;    right: -7px; } </style>       </head>         <body> <!-- Fork ribbon -->  <a class="github-fork-ribbon" href="https://github.com/luisadha/weapon-url-opener-nightly"     data-ribbon="Contribute on GitHub" title="Contribute on GitHub">   Contribute on GitHub  </a>         <p><a href="https://luisadha.github.io/weapon-url-opener-nightly">Weapon-Url-Opener-Nightly</a> Switch downloader scripts easily and quickly. Now you can use the termux-url-opener feature more often.</p>         <p>‚Äî Gunakan   self-hosted ini untuk mengganti plugin termux-url-opener anda dengn cepat.</p>         <p>             <h3>Preview</h3>             <a href="https://asciinema.org/a/704914" target="_blank">                 <img src="https://asciinema.org/a/704914.svg" alt="Preview animation" style="max-width: 100%; height: auto;" />             </a>  <pre><code class="language-shell"> <!--
# `weapon-url-opener-nightly(1)` installer script that fetches the canonical `setup.sh` script and runs it
# in the calling context.
# Author: luisadha (c) 2025
# Sangat cepat rata-rata 24 ms.

ENV=~/bin/.env; touch "$ENV"; source "$ENV";

# Version v2.3.30 Added: New builtin options
CATCH_URL="${TERMUX_URL_OPENER_SHARED_DATA:-"Please share the link, and I‚Äôll take care of the rest."}"
VERSION="v2.4.16"
DEBUG=0
lang=""
BASE="$HOME/.local/state/wuo/"
CACHE="$HOME/.local/state/wuo/lang"
STATE="$HOME/.local/state/wuo/lang.auto"
touch "$CACHE"
mkdir -p "$BASE"
debug_log() {  
  if [ "$DEBUG" -eq 1 ]; then  
    echo -ne "[DEBUG] " "$*" >&2;
  fi 
}
normal_log() {
  if [ "$DEBUG" -eq 0 ]; then 
    echo -ne "$*"
  fi 
}


# üîç Deteksi opsi
if [[ $# -eq 0 ]]; then
  touch ~/.local/state/wuo/lang.default; 
  lang="default" #en # Agar eksekusi cepat
fi

for arg in "$@"; do
  case "$arg" in
    --help)
cat <<'EOF'
WUO-Nightly  Switch downloader scripts easily and quickly. Now you can use the termux-url-opener feature more often.
Usage :
        --debug              Print debug/verbose         
        --install-plugin     Install the termux-url-opener add-on required for this tool to work
        --lang=[auto/en/id]  Change languages
        --version            Print version
        --help               Print this message
EOF
  exit 0;
      ;;
    --debug)
      DEBUG=1
      ;;
    --version)
      echo "weapon-url-opener-nightly $VERSION"
      exit 0;
      ;;
    --install-plugin)
      echo -e "You will install 2 plugin for (Fist-installations) this will be added to ~/bin after installation are complete";
      curl -sSL https://raw.githubusercontent.com/luisadha/weapon-url-opener/refs/heads/master/install-plugin.sh | bash
      ;;
    --lang=*)
      LANG_ARG="${arg#--lang=}"
      ;;
  esac
done

# Atur lang setelah parsing
if [[ "$LANG_ARG" == "auto" ]]; then
  termux-tts-engines | yq -o t | cut -f1,3 --complement | xargs | awk '{print $2}' > "$CACHE"
  touch "$STATE"
  lang="auto"
elif [[ "$LANG_ARG" == "id" ]]; then
  echo "Pengenalan" > "$CACHE"
  lang="id"
elif [[ "$LANG_ARG" == "en" ]]; then
  echo "Speech" > "$CACHE"
  lang="en"
elif [[ -n "$LANG_ARG" ]]; then
  echo "undefined"
  exit 3
fi

# Jika lang tidak ditentukan tapi debug aktif, fallback
if [[ -z "$lang" && $DEBUG -eq 1 ]]; then
  lang="default"
  touch "$BASE/lang.default"
fi
  

if [[ -z "$lang" && -w "$STATE" && -w "${BASE}/lang.default" ]]; then 
  case "$(cat "$CACHE")" in
    Pengenalan) 
                lang="id" ;;
    Speech)     
                lang="en" ;;
    "")
                lang="" ;;
  esac
fi
debug_log "Detection language: $lang\n"

# Map Bahasa Indonesia
declare -A map_id=(
  [info_t]='Gunakan ‚Üë ‚Üì untuk navigasi, Enter untuk pilih'
  [choosed_n]='Tidak memilih'
  [info_c]='Keluar dari skrip ini'
  [info_e]='Keluar'
  [banner]='WUO adalah alat penyedia termux-url-opener'
  [prompt_s]='Pilih senjata utamamu:'
  [toogle_u]='Digunakan'
  [choosed_y]='Kamu memilih'
  [info_s]='Sebagai senjata utamamu'
)

# Map Bahasa Inggris
declare -A map_en=(
  [info_t]='Use ‚Üë‚Üì to navigate, Enter to select'
  [choosed_n]='Not choosed yet'
  [info_c]='Program close'
  [info_e]='Exit'
  [banner]='Weapon-Url-Opener-Nightly'
  [prompt_s]='Choose your main weapon:'
  [toogle_u]='In Use:'
  [choosed_y]='You choosed'
  [info_s]='as your primary weapon'
)

# Fungsi untuk ambil string berdasarkan key
trmap() {
  locale="$(cat "$CACHE")";
  case "$locale" in
    Pengenalan) lang="id" ;;
    Speech)     lang="en" ;;
    *)          lang="en" ;;  # fallback default
   esac
debug_log "Query detected: ${locale:="(system detection)"}\n"

  case "$lang" in
    id) echo "${map_id[$1]}" ;;
    en) echo "${map_en[$1]}" ;;
    *) echo "Unknown language" ;;
  esac
  debug_log "Mapped language: $lang\n"
}
update_system() {
  pip install -U yt-dlp;
};
parameter_passing() {
  echo "$CATCH_URL"
};
patch_all_handler_termux_url_opener() {

PATCH_ID="# PATCH by Weapon-Url-Opener-Nightly"
read -r -d '' PATCH_CODE <<'EOF'
export TERMUX_URL_OPENER_SHARED_DATA="$1" # Bagian ini harus tetap $1
  
grep -q '^TERMUX_URL_OPENER_SHARED_DATA=' ~/bin/.env || env | grep "^TERMUX_URL_OPENER_SHARED_DATA=" >> ~/bin/.env
  
[ "$(md5sum "$0" | awk '{print $1}')" = "$(md5sum ~/bin/termux-url-opener | awk '{print $1}')" ] && echo "Initializing.." || exec ~/bin/termux-url-opener "$CATCH_URL"
weapon-url-opener-nightly
[ "$(md5sum "$0" | awk '{print $1}')" = "$(md5sum ~/bin/termux-url-opener | awk '{print $1}')" ] && echo "Initializing.." || exec ~/bin/termux-url-opener "$CATCH_URL"
EOF

for file in ~/bin/*.sh; do
  [ -f "$file" ] || continue

  echo "üõ†  Memeriksa $file ..."
  content="$(<"$file")"

  # Lewati kalau sudah ditambal
  if grep -qF "$PATCH_ID" <<< "$content"; then
    echo "‚úÖ Sudah ditambal, dilewati."
    continue
  fi

  new_content=""
  inserted=0
  shebang_done=0
  credit_done=0
  patch_lines=0

  while IFS= read -r line; do
    # Hormati shebang, tapi hanya sekali
    if [[ $shebang_done -eq 0 && "$line" =~ ^#! ]]; then
      new_content+="$line"$'\n'
      shebang_done=1
      continue
    fi

    # Hormati credit, jika ada dan belum pernah diproses
    if [[ $credit_done -eq 0 && "$line" =~ [Cc]redit ]]; then
      new_content+="$line"$'\n'
      new_content+="$PATCH_ID"$'\n'"$PATCH_CODE"$'\n'
      inserted=1
      credit_done=1
      patch_lines=$(wc -l <<< "$PATCH_CODE")
      continue
    fi

    new_content+="$line"$'\n'
  done <<< "$content"

  # Jika tidak ada credit dan belum insert
  if [[ $inserted -eq 0 ]]; then
    if [[ $shebang_done -eq 1 ]]; then
      IFS=$'\n' read -d '' -r -a lines <<< "$new_content"
      new_content="${lines[0]}"$'\n'"$PATCH_ID"$'\n'"$PATCH_CODE"
      for ((i=1; i<${#lines[@]}; i++)); do
        new_content+=$'\n'"${lines[i]}"
      done
      patch_lines=$(wc -l <<< "$PATCH_CODE")
    else
      new_content="$PATCH_ID"$'\n'"$PATCH_CODE"$'\n'"$new_content"
      patch_lines=$(wc -l <<< "$PATCH_CODE")
    fi
  fi

  # Sekarang kita pisahkan PATCH dan bagian asli
  patch_part=$(head -n $((patch_lines + 1)) <<< "$new_content")
  original_part=$(tail -n +$((patch_lines + 2)) <<< "$new_content")

  # Ganti semua $1 dan "$1" di bagian asli SAJA
  original_part="${original_part//\"\$1\"/\$TERMUX_URL_OPENER_SHARED_DATA}"
  original_part="${original_part//\$1/\$TERMUX_URL_OPENER_SHARED_DATA}"

  # Gabungkan kembali
  final_content="$patch_part"$'\n'"$original_part"

  printf '%s' "$final_content" > "$file"
  echo "‚úÖ Patch selesai di $file"
done

#grep -n 'weapon-url-opener-nightly' ~/bin/*.sh 2>/dev/null --color=always > ~/bin/PATCH_ALL_HANDLER_SCRIPT
};
# Masuk ke folder koleksi
debug_log "Entering dir: " && pushd ~/bin &>/dev/null || exit
# Tambahkan dekripsi untuk opsi Exit

# AUTOMATE
parameter_passing > ~/bin/PARAMETER_FORWARDING
ABOUT=""
trmap info_c > ~/bin/EXIT
__banner__="$(trmap banner)"

# Hitung skrip provider
#count_plugin=$(ls ~/bin/*.sh| wc -l)
# Hitung hash dari termux-url-opener
ref_hash=$(md5sum ~/bin/termux-url-opener 2>/dev/null | awk '{print $1}')

# Ambil semua file .sh dalam urutan waktu
IFS=$'\n' read -d '' -r -a file_list < <(\ls -Art ~/bin/*.sh 2>/dev/null || :)

# Ambil hanya nama file-nya
IFS=$'\n' read -d '' -r -a file_list < <(printf "%s\n" "${file_list[@]}" | xargs -n1 basename 2>/dev/null )

# Tambahkan Opsi builtin di akhir

file_list+=("UPDATE_YT-DLP")
file_list+=("PARAMETER_FORWARDING")
file_list+=("PATCH_ALL_HANDLER_SCRIPT")
file_list+=("EXIT")
  
# Cari file yang sedang 'in use' (hash sama dengan termux-url-opener)
toggle=""
for file in "${file_list[@]}"; do
  [[ "$file" == "EXIT" ]] && continue
  [[ "$file" == "UPDATE_YT-DLP" ]] && continue
  [[ "$file" == "PARAMETER_FORWARDING" ]] && continue
  [[ "$file" == "PATCH_ALL_HANDLER_SCRIPT" ]] && continue
# Tambahkan disini jika menambah opsi builtin baru
  
  file_hash=$(md5sum ~/bin/"$file" 2>/dev/null | awk '{print $1}')
  if [[ "$file_hash" == "$ref_hash" ]]; then
    toggle="${file%.*}";
    break
  fi
done
# Siapkan header jika ada file yang in use
if [[ -n "$toggle" ]]; then
  fzf_header="$__banner__"
  current="$toggle"
else
  fzf_header="$__banner__"
  current="$toggle"
fi
# Cache biar cepat
c_y="$(trmap choosed_y )"; 
i_s="$(trmap info_s)";
inuse="$(trmap toogle_u)";
pr="$(trmap prompt_s)";
no_input="$(trmap choosed_n)";
eof="$(trmap info_e)";
tip="$(trmap info_t)";
list_label="Handler & Options"
opts="${#file_list[@]}"
wrap() {
  echo "$1" | fold -s -w "$2"
}
box="${fzf_header}"
prompt=$(wrap "$pr" 40)


weapon=$(printf '%s\n' "${file_list[@]}" | awk -F. '{
    with_ext = $1 
    printf "%d\t%s\t%s\n", NR, with_ext, $0
  }' | fzf --prompt=">_ " \
  --ghost="$tip " \
  --ansi \
  --border \
  --margin=2,2,2,2 \
  --padding=0,1,0,1 \
  --header-first \
  --header="$box" \
  --header-border="sharp" \
  --header-lines-border="sharp" \
  --height=60% \
  --min-height=${opts}+ \
  --layout=reverse \
  --info=inline-right \
  --tabstop=2 \
  --ellipsis='+'\
  --gap=1 \
  --gap-line='-' \
  --color="bg+:-1,fg:gray,fg+:white,border:cyan,spinner:0,hl:yellow,header:blue,info:green,pointer:red,marker:blue,prompt:gray,hl+:red" \
  --no-separator \
  --ansi --input-label="$(echo -e "\033[36m[\033[35m $inuse \033[32m$current \033[36m]\033[0m")" \
  --track \
  --input-border='sharp' \
  --list-border="sharp" \
  --list-label="$(echo -e "\033[36m[ \033[35m${list_label} \033[36m]\033[0m")" \
  --list-label-pos=0 \
  --highlight-line \
  --preview='bat --color=always --style=plain --paging=never --theme OneHalfDark {3}' \
  --preview-window='right,45%,wrap' \
  --with-nth=1,2 \
  --delimiter=$'\t' \
  --exit-0 | cut -f3) 
 
# Jika tidak memilih apa-apa, keluar
if [[ "$weapon" == "" ]]; then
  echo "$no_input"
  exit 2
fi
# Jika memilih AUTO_UPDATE_YTDL
if [[ "$weapon" == "UPDATE_YT-DLP" ]]; then
  update_system > ~/bin/UPDATE_YT-DLP 2>&1;
  echo "$(cat ~/bin/AUTO_UPDATE_YT-DLP)"
  exit 0;
fi;
# Jika memilih PARAMETER_FORWARDING
if [[ "$weapon" == "PARAMETER_FORWARDING" ]]; then
  exit 0;
fi;
# Jika memilih Menambal
if [[ "$weapon" == "PATCH_ALL_HANDLER_SCRIPT" ]]; then
  patch_all_handler_termux_url_opener > ~/bin/PATCH_ALL_HANDLER_SCRIPT 2>&1;
  echo "All handler scripts patched successfully!";
  exit 0;
fi;
# Jika memilih Keluar
if [[ "$weapon" == "EXIT" ]]; then
  echo "$eof"
  exit 1;
fi
rep="$(basename "$weapon")";
# Jalankan aksi
normal_log "$c_y" "$rep" "$i_s"
debug_log "Your Reply: $weapon\n"
sleep 0.1;
cp -f ~/bin/"$weapon" ~/bin/termux-url-opener
start=$(date +%s%N)
debug_log "Leaving dir.. " && cd "$OLDPWD" && printf "\n" # kode yang ingin diukur
end=$(date +%s%N)
#DEBUG 
debug_log "Time Elapsed: $(( (end - start)/1000000 )) ms\n"

# --> </code></pre><h3>Bermain di Termux</h3><div class="share-line"><span>Salin kode di bawah atau</span><button onclick="share()"><img src="./assets/img/share-icon.png" alt="Share Icon" width="11px" height="11px"> Bagikan ke Termux (harus Nene-Ak47)</button>  </div> <pre>    <code class="language-shell">. &lt;(curl -L luisadha.github.io/weapon-url-opener-nightly)</code></pre>   <div class="note">       <strong>Catatan: </strong>       Agar tombol <em>Bagikan ke Termux</em>      berfungsi dengan benar, kamu harus mengganti handler   </div> <code>termux-url-opener</code>ke Nene-Ak47. Panduan lengkap silahkan baca di <a href="https://github.com/luisadha/nene#api">https://github.com/luisadha/nene#api</a>       <footer>          <p> (C) 2021‚Äì2025            <a href="https://luisadha.my.id">luisadha.my.id</a>          <a href="https://github.com/luisadha">github.com/luisadha</a>           </p>       </footer>           </body>           </html>
